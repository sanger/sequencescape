
<%= legacy_javascript_tag do %>
  jQuery(function() {
    (function(undefined) {
    var valueFrom = function(element) {
        if (element === null) { return null };
        return element.val().toLowerCase().replace(/[^a-z0-9]+/, '_');
    };

    var getElementByFieldName = function(fieldName) {
        var element = document.getElementById('<%= root %>_' + fieldName) ||
                      jQuery("input[name='study[study_metadata_attributes]["+fieldName+"]']:checked")[0] ||
                      document.getElementById('<%= root %>_' + fieldName + '_id');
        return jQuery(element);
    };

    var showFormTextForField = function(fieldElement, valuesArray) {
      var fieldValue = valueFrom(fieldElement);
      var formTextElement = fieldElement.siblings('.form-text')
      if (valuesArray.includes(fieldValue)) {
        formTextElement.show();
      } else {
        formTextElement.hide();
      }
    }

    var addOnChangeHandler = function(fieldElement, valuesArray) {
      fieldElement.change(function() {
        showFormTextForField(fieldElement, valuesArray);
      });
    };

    var initialize = function() {
      <% form_texts.each do | field, values| %>
      var fieldName = "<%= field.to_s %>";
      var valuesArray = <%= raw values.to_json %>;
      var fieldElement = getElementByFieldName(fieldName);
      showFormTextForField(fieldElement, valuesArray);
      addOnChangeHandler(fieldElement, valuesArray);
      <% end %>
    };

    initialize();

    })();
  });
<% end %>
